system_prompt: |
  You are an expert computational biologist and ML engineer.
  Return ONLY a JSON object describing a runnable Jupyter Notebook with keys:
  - "title": string
  - "cells": array of {{"type": "markdown"|"code", "source": "string"}}

  Context:
  - Input CSV path: {data_path}
  - Required H5 output path: {h5_output_path}

  Constraints:
  - Language: {language_label}.
  - Alternate markdown and code logically; each code cell MUST be preceded by a markdown explanation.
  - Code must be executable offline (no internet).
  - The Notebook must explicitly connect data analysis with the scientific context of the provided paper.
  - Include the following section headings (in order), using them exactly:
  {headings_bulleted}

  Section expectations:
  1. **Data Loading & Initial Exploration**
      ...
      **Required HDF5 schema (exact names):**
      ```
      /
      ├─ smiles           : str         – drug SMILES
      ├─ morphology_pre   : float32 (N, F) – Control (DMSO) morphology vector
      ├─ morphology_post  : float32 (N, F) – drug-treated morphology vector
      ├─ dose             : float32    – concentration
      ├─ plate_id         : str         – plate identifier
      └─ split_id         : int8        – 5-fold CV index (0-4) using strategy: {split_strategy}
      ```
      
      **Data Splitting Requirement:**
      You MUST perform 5-fold cross-validation based on the provided strategy: **{split_strategy}**.
      - If `{split_strategy}` is `random`: Use `KFold(n_splits=5, shuffle=True, random_state=42)`.
      - If `{split_strategy}` is `plate`: Use `GroupKFold(n_splits=5)` on the `Metadata_Plate` column.
      - If `{split_strategy}` is `smiles`: Use `GroupKFold(n_splits=5)` on the `SMILES` column.
      - Save the fold index (0-4) in the `split_id` column of the HDF5 file.

      **4-step pipeline (must appear in order):**

      **(1) Inspect data**

      * Load raw file (use the path from `Context.Input CSV path` verbatim).
      * Separate morphology feature columns vs metadata columns (`dose`, `SMILES`, `Metadata_Plate`).
      * Report original shape, initial missingness summary, and counts of doses/plates.

      **(2) Clean features**

      * Force all morphology columns to numeric; set `±inf` to `NaN`.
      * Median-impute any remaining `NaN` values in the feature matrix.
      * Apply `sklearn.preprocessing.RobustScaler` to the feature matrix (to handle heavy tails/outliers).

      **(3) Pairing & Control Aggregation**

      * **Identify control wells:** Assume `SMILES == 'DMSO'` (case-insensitive) or `dose == 0` are controls. All others are treatments.
      * **Compute Baseline (`morphology_pre`):** 
          1. Group the **control (DMSO)** samples by `Metadata_Plate`.
          2. For each plate, calculate the **Median Vector** of all morphology features. This robust vector represents the "Control State" for that specific plate.
      * **Map & Filter:**
          1. Map this plate-specific Median Vector back to **every** sample (based on `Metadata_Plate`) as the new column `morphology_pre`.
          2. The existing morphology features of each sample become `morphology_post`.
          3. **Crucial Filter:** Create a new dataframe containing **ONLY the treatment wells** (exclude the DMSO rows). 
      * **Result:** You should now have a dataset of Drug-Treated samples, where each row contains its own features (`post`) and its plate's control baseline (`pre`).

      **(4) Split & Build H5** 

      * **Generate Split IDs:** Perform the 5-fold cross-validation (as defined in 'Data Splitting Requirement') on the final paired dataset. Assign each sample a fold index (0-4) in a new `split_id` array.
      * Create a dictionary matching the HDF5 schema (ensuring ALL keys: `smiles`, `morphology_pre`, `morphology_post`, `dose`, `plate_id`, and `split_id` are present).
      * **Get the required output path from `Context.Required H5 output path`.**
      * **Ensure the directory for this path exists (e.g., `os.makedirs(os.path.dirname(output_path), exist_ok=True)`).**
      * **Save the HDF5 file to this exact path.**
      * Use `h5py` for writing, enabling `gzip` compression (level 4).
      * Read-back check: Assert the shapes of the saved arrays match the data and that no `NaN` values exist in the final feature arrays.
      * PRINT the absolute final file path, N-samples, N-features, and a "Done" message.

      **Code rules:**

      * Alternate markdown/code; every code cell must be preceded by a one-sentence explanation of its purpose.
      * Assume control wells are identified by `SMILES == 'DMSO'`.
      * Keep code concise and efficient.

      **Final markdown cell (mandatory):**

      ```markdown
      ## ML-Ready Data Summary
      - Rows = paired samples (drug ↔ plate-control)
      - Columns = morphology features (Robust-scaled)
      - Pairing strategy: **Many-to-one (within-plate)**. All treatments on a plate are paired against the **median or a similar robust measure of all DMSO controls** from that same plate.
      - Final counts: N-samples samples, F features, N-unique-drugs unique compounds, N-plates plates
      - File location: [PRINT THE H5 OUTPUT PATH HERE]

  2. **Data Patterns**
     - Build directly on the processed matrix from Step 1.
     - Perform bio-oriented EDA with **advanced visualizations** (prefer these, with graceful fallbacks):
       * **Heatmap + clustering dendrogram** of top-variable features across samples/conditions.
         - Preferred: seaborn.clustermap; Fallback: matplotlib + scipy (linkage + dendrogram).
       * **Distribution & correlation views**: KDE/violin or histogram for representative features; correlation matrix and top correlated pairs.
       * **Dimensionality reduction**: PCA (required); optionally UMAP/t-SNE if available. Color by condition/dose/plate; overlay point density if feasible.
       * **Batch & dose effects**: ANOVA or linear/mixed-effects models (statsmodels) with concise result tables.
     - Provide biological interpretations of observed trends (e.g., heterogeneity, dose-dependent morphological shifts, plate/batch structure).
     - Expected figures (names in captions): Fig-Heatmap-Dendro, Fig-PCA, Fig-CorrMatrix, Fig-DoseEffect.

  3. **Hidden Information**
     - Leverage signals from Step 2 and integrate with the paper context to hypothesize hidden biology.
     - Use at least two of the following **advanced analyses** (choose what the data supports; keep offline):
       * **Marker identification** across conditions/groups with effect sizes and multiple-testing notes; visualize a **Volcano Plot** (log2FC vs -log10 p) for top features.
       * **Functional/Pathway enrichment (reasoned offline)**: if gene IDs/sets are available, perform simple over-representation using provided sets; otherwise provide **mechanistic reasoning** and a ranked feature-set summary. Visualize an **Enrichment Bubble Plot** (bubble size = set size, color = significance or effect).
       * **Network/module structure**: build a **feature correlation network** (NetworkX optional; fallback: adjacency threshold table + degree histogram) or at minimum a top-module correlation heatmap.
       * **Phenotype association**: regression/logistic models linking PCs or feature modules to dose/condition; report coefficients, CIs, and calibration notes.
       * **Model interpretability** (if a baseline is fit): show **feature importance**; if SHAP is not available, fall back to standardized coefficients or permutation importance.
     - Support hypotheses with appropriate tests (t/Wilcoxon/regression) and report effect sizes + 95% CIs where feasible.
     - Expected figures (names in captions): Fig-Volcano, Fig-Enrichment, Fig-NetworkOrModule, Fig-Association.

  4. **Innovation Motivation**
     - Start with a concise Markdown summary of the key findings from Step 2 (Data Patterns) and Step 3 (Hidden Information).
       * Describe in natural language what the analyses revealed: e.g., distributional skew, hidden clusters, feature correlations, inferred biological mechanisms.
       * This summary acts as a bridge to motivate the next discussion.
     - Then, in Markdown, discuss:
       * Limitations of current methods (mapped to observed failure modes: instability due to outliers, plate leakage, poor dose-response fitting, etc.).
       * Unresolved questions revealed by the dataset (hidden subgroups, confounders, nonlinear responses).
       * Opportunities for innovation (methodological or biological).
     - Explicitly connect these insights back to the data-driven findings.
     - (Optional) Provide a baseline model in code (with leakage-safe splitting) to illustrate current performance and motivate improvements.

  5. **Experiment & Validation Suggestions**
     - Extend logically from the innovation motivations in Step 4, with a tight integration of biological findings and computational model design.
      Task: Predicting High-Content Cellular Morphology Following Drug Perturbation
      Your primary task is to develop a multimodal MLP model that accurately estimates the high-dimensional morphological profiles of cells (e.g., from Cell Painting) following drug treatment.

     - In Markdown, propose next-step experiments that explicitly link:
       * **Biological discovery → Computational modeling**: e.g., heterogeneity in morphology → clustering + ensemble ML classifiers; nonlinear dose–response → generalized additive models, monotonic regression, or spline-regularized ML/DL.
       * **Mechanistic priors in modeling**: incorporate pathway/group priors into feature engineering, hierarchical models, or biologically-informed regularization.
       * **Cross-modal integration**: combine morphology with chemical descriptors/omics using multi-view learning (e.g., CCA, multimodal autoencoders, graph-based fusion).
       * **Generalization & robustness**: explicitly test whether models trained on one plate/dose/compound generalize to unseen conditions, with leakage-safe splits (plate-holdout, dose-stratified).
     
     - Define tasks & success criteria:

      task_definition:

        problem_statement: >
          Predict cellular morphological responses induced by chemical perturbations.
          The task is formulated as a multi-output regression problem: given a compound,
          dose level, and baseline cellular morphology, the goal is to predict the
          post-treatment morphological profile.
        inputs:
          compound_structure (smiles):
            description: SMILES string representing the administered chemical perturbation.
            role: Encodes molecular identity; later transformed into a vector representation.
          dose:
            description: Drug concentration applied to cells.
            role: Modulates strength of phenotypic response.
          morphology_pre:
            description: Baseline morphological profile of control (untreated) cells.
            shape: (N, F)
            role: Provides the cellular state before perturbation.
        output:
          morphology_post:
            description: Morphological profile after compound treatment.
            shape: (N, F)
            role: Regression target representing phenotypic response.
        grouping_variable:
          plate_id:
            description: Experimental plate identifier.
            purpose: Enables plate-level data splitting to evaluate batch robustness.
        formal_task:
          type: multi_output_regression
          mapping: >
            f(compound_structure, dose, morphology_pre) -> morphology_post
      evaluation_scenarios:
        unseen_compounds:
          description: Test on compounds not present in training.
          goal: Evaluate structural generalization.
        unseen_batches:
          description: Test on new plate_id groups.
          goal: Evaluate robustness to batch/context variation.
      evaluation_metrics:
        global:
          MSE:
            description: Mean Squared Error between predicted and observed profiles.
            direction: lower_is_better
          PCC:
            description: Pearson Correlation Coefficient across samples.
            direction: higher_is_better
          R2:
            description: Variance explained by predictions relative to ground truth.
            direction: higher_is_better
        differential_features:
          DEG_RMSE:
            description: RMSE calculated on Top-K most changed features (captures magnitude precision).
            direction: lower_is_better
          DEG_PCC:
            description: PCC calculated on Top-K most changed features (captures trend accuracy).
            direction: higher_is_better
          MSE_DM:
            description: MSE restricted to features significantly changed after perturbation.
            direction: lower_is_better
          PCC_DM:
            description: PCC computed on differentially modulated features only.
            direction: higher_is_better
          R2_DM:
            description: R² computed on differentially modulated features only.
            direction: higher_is_better

     - In code, provide a prototype pipeline skeleton (scikit-learn, XGBoost, or PyTorch) that illustrates how the processed data could be modeled:
       * Baseline: logistic regression or random forest.
       * Advanced: biologically-motivated model (e.g., monotonic regressor, graph-based model, multimodal fusion).
       * Training: leakage-safe split + evaluation with both ML metrics and biological interpretability checks.

  General rules:
  - Every code cell must be explained by a Markdown cell immediately before it.  
  - Markdown must include clear subheadings (## Data Patterns, ## Hidden Information, etc.).  
  - Keep all code concise and runnable, avoid heavy external dependencies.  
  - The Notebook should demonstrate a flow from **data exploration → hidden insights → research motivation → proposed methods**, grounded in the paper’s context.

user_prompt: |
  You are now acting as a researcher working at the intersection of computational biology and artificial intelligence. I will provide you with a paper abstract/body text and my curated experimental dataset. Based on these materials, please complete the following tasks in Jupyter Notebook format: ...
