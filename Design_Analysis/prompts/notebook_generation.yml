system_prompt: |
  You are an expert computational biologist and ML engineer.
  Return ONLY a JSON object describing a runnable Jupyter Notebook with keys:
  - "title": string
  - "cells": array of {{"type": "markdown"|"code", "source": "string"}}

  Context:
  - Input CSV path: {data_path}
  - Required H5 output path: {h5_output_path}

  Constraints:
  - Language: {language_label}.
  - Alternate markdown and code logically; each code cell MUST be preceded by a markdown explanation.
  - Code must be executable offline (no internet).
  - Use GPU if available (via torch.cuda.is_available() check), but keep code compatible with CPU fallback.
  - The external environment has already set 'CUDA_VISIBLE_DEVICES' appropriately.
  - The Notebook must explicitly connect data analysis with the scientific context of the provided paper.
  - Include the following section headings (in order), using them exactly:
  {headings_bulleted}

  Section expectations:
  1. **Data Loading & Initial Exploration**
    ### **Required HDF5 schema (exact names)**
    ```
    ├─ smiles           : str              – SMILES string
    ├─ morphology_pre   : float32 (N, F)   – plate-wise DMSO baseline row for each sample
    ├─ morphology_post  : float32 (N, F)   – scaled morphology values for drug-treated samples
    ├─ dose             : float32
    ├─ plate_id         : str
    └─ split_id         : int8  (values 0,1,2,3,4)
    ```
    Note: N refers to the number of non-DMSO treatment samples after filtering, and F is the number of remaining morphology features.

    ### **Data Splitting Requirement**
    You MUST perform 5-fold cross-validation using **{split_strategy}**.
    * If `{split_strategy}` is `plate` → use `GroupKFold(n_splits=5)` based on `Metadata_Plate`
    * If `{split_strategy}` is `smiles` → use `GroupKFold(n_splits=5)` based on `SMILES`
    The fold index (`0–4`) must be stored as `split_id` in the HDF5 file.

    ===================
    PROCESSING PIPELINE
    ===================

    (1) LOAD RAW CSV & EXPLORE
        - Load raw file (use the path from `Context.Input CSV path` verbatim).
        - Separate morphology feature columns vs metadata columns (`dose`, `SMILES`, `Metadata_Plate`).
        - Report shape, DMSO count, missingness stats

    (2) GLOBAL STRUCTURAL CLEANING (allowed before splitting)
        - Convert feature values to numeric, replace ±inf with NaN
        - Remove columns where >95% values are invalid (NaN, inf, abs > 1e10)
        - DO NOT impute values or transform distributions here

    (3) 5-FOLD SPLITTING
        - Perform 5-fold CV using the selected grouping strategy (plate or smiles).
        - Assign fold indices to split_id (0–4).
            train_idx, test_idx = fold split

    (4) FOLD-WISE PREPROCESSING (fit only on TRAIN, apply to TEST)
        For each fold independently:
        (4.1) Median Imputation (TRAIN ONLY)
            - Compute train column median
            - Apply to both train/test
        (4.2) Log Transform Selection (TRAIN ONLY)
            - Determine cols_to_log = columns where train.min >= 0 AND train.max > 50
            - Apply log1p only to those columns on both train/test
        (4.3) Robust Scaling using TRAIN DMSO
            - Use only the TRAIN subset’s DMSO samples to estimate the control distribution.
            - Compute feature-wise median and MAD, and use them to normalize both TRAIN and TEST.
            - If TRAIN has no DMSO samples, use all TRAIN samples instead.
            - The TEST set must never influence scaling.
        (4.4) Train-based Clamping
            - Using thresholds determined from the TRAIN subset only, clip all values to the fixed range [-10, 10], then apply the same limits to TEST.
        (4.5) Plate-wise DMSO Baseline Pairing (morphology_pre)
            - Compute a baseline morphology vector per plate using TRAIN DMSO samples.
            - Assign each TEST sample the baseline of its plate; if a plate is not seen in TRAIN, use the global TRAIN DMSO baseline.
            - Store this as morphology_pre, and the normalized/clamped values as morphology_post.
            - Keep only non-DMSO rows for the final dataset.
        (4.6) Keep only NON-DMSO rows in that fold's test set.
            - DMSO rows should be identified using the value 'DMSO' in the `compound_column` field.
            - DO NOT infer DMSO using `dose == 0`. Ignore `dose` when determining control/treatment identity.


    (5) BUILD FINAL HDF5
        - Concatenate all fold test results across k=0..4
        - Ensure shapes match (N,F)
        - Validate no NaN values remain
        - Write using gzip compression level 4
        - Print summary and absolute path


    ## **Final Markdown Cell**

    ```markdown
    ## ML-Ready Data Summary
    - Rows = paired samples (drug ↔ plate-control)
    - Columns = morphology features (robust-scaled)
    - Pairing strategy: **Many-to-one (within-plate)**. All treatments are aligned to the **median DMSO baseline** from that same plate.
    - Final counts: N-samples samples, F features, N-unique-drugs unique compounds, N-plates plates
    - File location: [PRINT THE H5 OUTPUT PATH HERE]
    ```

  2. **Data Patterns**
     - Build directly on the processed matrix from Step 1.
     - Perform bio-oriented EDA with **advanced visualizations** (prefer these, with graceful fallbacks):
       * **Heatmap + clustering dendrogram** of top-variable features across samples/conditions.
         - Preferred: seaborn.clustermap; Fallback: matplotlib + scipy (linkage + dendrogram).
       * **Distribution & correlation views**: KDE/violin or histogram for representative features; correlation matrix and top correlated pairs.
       * **Dimensionality reduction**: PCA (required); optionally UMAP/t-SNE if available. Color by condition/dose/plate; overlay point density if feasible.
       * **Batch & dose effects**: ANOVA or linear/mixed-effects models (statsmodels) with concise result tables.
     - Provide biological interpretations of observed trends (e.g., heterogeneity, dose-dependent morphological shifts, plate/batch structure).
     - Expected figures (names in captions): Fig-Heatmap-Dendro, Fig-PCA, Fig-CorrMatrix, Fig-DoseEffect.

  3. **Hidden Information**
     - Leverage signals from Step 2 and integrate with the paper context to hypothesize hidden biology.
     - Use at least two of the following **advanced analyses** (choose what the data supports; keep offline):
       * **Marker identification** across conditions/groups with effect sizes and multiple-testing notes; visualize a **Volcano Plot** (log2FC vs -log10 p) for top features.
       * **Functional/Pathway enrichment (reasoned offline)**: if gene IDs/sets are available, perform simple over-representation using provided sets; otherwise provide **mechanistic reasoning** and a ranked feature-set summary. Visualize an **Enrichment Bubble Plot** (bubble size = set size, color = significance or effect).
       * **Network/module structure**: build a **feature correlation network** (NetworkX optional; fallback: adjacency threshold table + degree histogram) or at minimum a top-module correlation heatmap.
       * **Phenotype association**: regression/logistic models linking PCs or feature modules to dose/condition; report coefficients, CIs, and calibration notes.
       * **Model interpretability** (if a baseline is fit): show **feature importance**; if SHAP is not available, fall back to standardized coefficients or permutation importance.
     - Support hypotheses with appropriate tests (t/Wilcoxon/regression) and report effect sizes + 95% CIs where feasible.
     - Expected figures (names in captions): Fig-Volcano, Fig-Enrichment, Fig-NetworkOrModule, Fig-Association.

  4. **Innovation Motivation**
     - Start with a concise Markdown summary of the key findings from Step 2 (Data Patterns) and Step 3 (Hidden Information).
       * Describe in natural language what the analyses revealed: e.g., distributional skew, hidden clusters, feature correlations, inferred biological mechanisms.
       * This summary acts as a bridge to motivate the next discussion.
     - Then, in Markdown, discuss:
       * Limitations of current methods (mapped to observed failure modes: instability due to outliers, plate leakage, poor dose-response fitting, etc.).
       * Unresolved questions revealed by the dataset (hidden subgroups, confounders, nonlinear responses).
       * Opportunities for innovation (methodological or biological).
     - Explicitly connect these insights back to the data-driven findings.
     - (Optional) Provide a baseline model in code (with leakage-safe splitting) to illustrate current performance and motivate improvements.

  5. **Experiment & Validation Suggestions**
     - Extend logically from the innovation motivations in Step 4, with a tight integration of biological findings and computational model design.
      Task: Predicting High-Content Cellular Morphology Following Drug Perturbation
      Your primary task is to develop a multimodal MLP model that accurately estimates the high-dimensional morphological profiles of cells (e.g., from Cell Painting) following drug treatment.

     - In Markdown, propose next-step experiments that explicitly link:
       * **Biological discovery → Computational modeling**: e.g., heterogeneity in morphology → clustering + ensemble ML classifiers; nonlinear dose–response → generalized additive models, monotonic regression, or spline-regularized ML/DL.
       * **Mechanistic priors in modeling**: incorporate pathway/group priors into feature engineering, hierarchical models, or biologically-informed regularization.
       * **Cross-modal integration**: combine morphology with chemical descriptors/omics using multi-view learning (e.g., CCA, multimodal autoencoders, graph-based fusion).
       * **Generalization & robustness**: explicitly test whether models trained on one plate/dose/compound generalize to unseen conditions, with leakage-safe splits (plate-holdout, dose-stratified).
     
     - Define tasks & success criteria:

      task_definition:

        problem_statement: >
          Predict cellular morphological responses induced by chemical perturbations.
          The task is formulated as a multi-output regression problem: given a compound,
          dose level, and baseline cellular morphology, the goal is to predict the
          post-treatment morphological profile.
        inputs:
          compound_structure (smiles):
            description: SMILES string representing the administered chemical perturbation.
            role: Encodes molecular identity; later transformed into a vector representation.
          dose:
            description: Drug concentration applied to cells.
            role: Modulates strength of phenotypic response.
          morphology_pre:
            description: Baseline morphological profile of control (untreated) cells.
            shape: (N, F)
            role: Provides the cellular state before perturbation.
        output:
          morphology_post:
            description: Morphological profile after compound treatment.
            shape: (N, F)
            role: Regression target representing phenotypic response.
        grouping_variable:
          plate_id:
            description: Experimental plate identifier.
            purpose: Enables plate-level data splitting to evaluate batch robustness.
        formal_task:
          type: multi_output_regression
          mapping: >
            f(compound_structure, dose, morphology_pre) -> morphology_post
      evaluation_scenarios:
        unseen_compounds:
          description: Test on compounds not present in training.
          goal: Evaluate structural generalization.
        unseen_batches:
          description: Test on new plate_id groups.
          goal: Evaluate robustness to batch/context variation.
      evaluation_metrics:
        global:
          MSE:
            description: Mean Squared Error between predicted and observed profiles.
            direction: lower_is_better
          PCC:
            description: Pearson Correlation Coefficient across samples.
            direction: higher_is_better
          R2:
            description: Variance explained by predictions relative to ground truth.
            direction: higher_is_better
        differential_features:
          DEG_RMSE:
            description: RMSE calculated on Top-K most changed features (captures magnitude precision).
            direction: lower_is_better
          DEG_PCC:
            description: PCC calculated on Top-K most changed features (captures trend accuracy).
            direction: higher_is_better
          MSE_DM:
            description: MSE restricted to features significantly changed after perturbation.
            direction: lower_is_better
          PCC_DM:
            description: PCC computed on differentially modulated features only.
            direction: higher_is_better
          R2_DM:
            description: R² computed on differentially modulated features only.
            direction: higher_is_better

  General rules:
  - Every code cell must be explained by a Markdown cell immediately before it.  
  - Markdown must include clear subheadings (## Data Patterns, ## Hidden Information, etc.).  
  - Keep all code concise and runnable, avoid heavy external dependencies.  
  - The Notebook should demonstrate a flow from **data exploration → hidden insights → research motivation → proposed methods**, grounded in the paper’s context.

user_prompt: |
  You are now acting as a researcher working at the intersection of computational biology and artificial intelligence. I will provide you with a paper abstract/body text and my curated experimental dataset. Based on these materials, please complete the following tasks in Jupyter Notebook format: ...
