# Generate_Execution

## Run
```bash
python cellscientist_phase_2.py --config generate_execution_config.json generate --baseline-id 0 --with-lit
```

Or run the full 3-phase pipeline:
```bash
python cellscientist_phase_2.py --config generate_execution_config.json run --baseline-id 0 --with-lit --which both
```

---

## Files
| File | Description |
|------|--------------|
| **cellscientist_phase_2.py** | Main entry. Controls the 3-phase pipeline: generate → execute → analyze. |
| **generate_execution_config.json** | Configuration file defining dataset paths, baseline sources, and LLM parameters. |

---

## design_execution/ Modules
| File | Description |
|------|--------------|
| **baseline_migrator.py** | Copies baseline notebooks into the results folder (`baselines/<date>`). Handles flexible matching of `*.ipynb`. |
| **trial_manager.py** | Creates trial directories from baselines and manages notebook-level improvements. |
| **literature_manager.py** | Handles optional literature search via OpenAlex, CSV → Markdown conversion, and LLM summarization of papers. |
| **llm_client.py** | Unified wrapper for LLM providers (OpenAI-compatible). Loads keys, handles retries, and logs conversations. |
| **patch_applier.py** | Applies the JSON patch generated by the LLM onto the unexecuted notebook. |
| **context_extractor.py** | Extracts summaries from notebooks or folders (used to provide context for the LLM). |
| **report_builder.py** | Builds Markdown reports summarizing results after execution. |
| **prompt_pipeline** | Orchestrates the prompt-defined branch: reads prompts/pipeline_prompt.yaml, calls the LLM to generate a single self-contained run.py, executes it, and writes metrics.json. |
| **__init__.py** | Package marker. |

## prompts/ Modules
| File | Description |
| **pipeline_prompt.yaml** | Specification for the prompt-defined branch: dataset paths/columns, split method , and metrics to compute. The orchestrator uses this to instruct the LLM. |

---


## Key Config Parameters (`generate_execution_config.json`)

### Top-level
* **dataset_name** — dataset identifier, used in all paths.  
  Example: `"BBBC036"` → baseline in `../baseline/BBBC036/`, results in `./results/BBBC036/`.

### paths
* **baseline_source_dir** — where baseline notebooks are stored (relative or absolute path).  
* **stage1_analysis_dir** — reference notebook directory from Phase-1 output.  
* **design_execution_root** — main output root for this phase.

### llm
* **provider / model** — defines which LLM endpoint to call (e.g., `yizhan`, `gpt-5`).  
* **base_url / api_key** — custom inference endpoint configuration.  

### experiment / trial
* **primary_metric** — key evaluation metric (e.g., `AUROC`).  
* **tag** — experiment tag used in trial naming.  
* **seed** — random seed for reproducibility.

### pipeline_mode

* **baseline** — use thee pipeline based on baseline code.
* **prompt** — bypass baselines and run the prompt-defined branch (agent generates and executes a single run.py with 5-fold CV and specified metrics).


### literature (optional)
* **query** — search keywords for literature retrieval (OpenAlex).  
* **n** — number of papers to fetch.  
* **llm_summarize** — whether to summarize papers with the LLM.  


---

## Typical Workflow

### **A. Generate Patch (LLM only)**
Generate improved notebook patches **without execution**.

#### Without literature (simpler, faster)

```bash
python cellscientist_phase_2.py --config generate_execution_config.json --pipeline-mode prompt generate 
```

#### With literature (adds OpenAlex search + LLM summarization)

```bash
python cellscientist_phase_2.py --config generate_execution_config.json --pipeline-mode prompt generate --with-lit
```

### **B. Execute**
Run baseline and patched notebooks:
```bash
python cellscientist_phase_2.py --config generate_execution_config.json --pipeline-mode prompt execute --which both
```

Outputs:
```
baseline_00_exec.ipynb
notebook_unexec_patched_exec.ipynb
```

### **C. Analyze**
Generate Markdown summary report:
```bash
python cellscientist_phase_2.py --config generate_execution_config.json --pipeline-mode prompt analyze
```
Report path:
```
./results/${dataset_name}/generate_execution/reports/Report_T<date>-improve-data-model-s22.md
```


### **D. Full Pipeline**
Run all three stages in sequence:
```bash
python cellscientist_phase_2.py --config generate_execution_config.json run --with-lit --which both
```


